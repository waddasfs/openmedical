<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>医生聊天 - 医疗咨询平台</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            height: 100vh;
            overflow: hidden;
        }
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .navbar-brand {
            font-weight: 600;
            color: white !important;
        }
        .nav-link {
            color: rgba(255,255,255,0.9) !important;
            font-weight: 500;
        }
        .nav-link:hover {
            color: white !important;
        }
        .chat-container {
            height: calc(100vh - 76px);
            display: flex;
            flex-direction: column;
        }
        .chat-header {
            background: white;
            border-bottom: 1px solid #e9ecef;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            background: #f8f9fa;
        }
        .chat-input {
            background: white;
            border-top: 1px solid #e9ecef;
            padding: 1rem;
            box-shadow: 0 -2px 4px rgba(0,0,0,0.05);
        }
        .message {
            margin-bottom: 1rem;
            display: flex;
            align-items: flex-start;
        }
        .message.doctor {
            justify-content: flex-end;
        }
        .message.patient {
            justify-content: flex-start;
        }
        .message-bubble {
            max-width: 70%;
            padding: 0.75rem 1rem;
            border-radius: 18px;
            position: relative;
        }
        .message.doctor .message-bubble {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }
        .message.patient .message-bubble {
            background: white;
            color: #333;
            border: 1px solid #e9ecef;
            border-bottom-left-radius: 4px;
        }
        .message-time {
            font-size: 0.75rem;
            color: #6c757d;
            margin-top: 0.25rem;
        }
        .message.doctor .message-time {
            text-align: right;
        }
        .message.patient .message-time {
            text-align: left;
        }
        .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 0.5rem;
        }
        .message.doctor .avatar {
            order: 2;
        }
        .message.patient .avatar {
            order: 0;
        }
        .consultation-info {
            background: white;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .status-badge {
            padding: 0.3rem 0.8rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        .status-in_progress {
            background-color: #d4edda;
            color: #155724;
        }
        .status-completed {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 8px;
            padding: 0.5rem 1rem;
            font-weight: 500;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        }
        .typing-indicator {
            display: none;
            padding: 0.75rem 1rem;
            background: white;
            border-radius: 18px;
            border: 1px solid #e9ecef;
            margin-bottom: 1rem;
            max-width: 70%;
        }
        .typing-dots {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #6c757d;
            animation: typing 1.4s infinite ease-in-out;
        }
        .typing-dots:nth-child(1) { animation-delay: -0.32s; }
        .typing-dots:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        .empty-messages {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }
        .empty-messages i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/doctor/consultations">
                <i class="fas fa-arrow-left me-2"></i>
                返回咨询列表
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/doctor/dashboard">
                    <i class="fas fa-tachometer-alt me-1"></i>仪表板
                </a>
            </div>
        </div>
    </nav>

    <div class="chat-container">
        <!-- 咨询信息头部 -->
        <div class="chat-header">
            <div class="consultation-info">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h6 class="mb-1">咨询 #<span id="consultationId">{{ consultation_id }}</span></h6>
                        <p class="text-muted mb-1" id="diseaseDescription">加载中...</p>
                        <div class="d-flex align-items-center">
                            <span class="status-badge status-in_progress" id="consultationStatus">进行中</span>
                            <small class="text-muted ms-2" id="consultationTime">-</small>
                        </div>
                    </div>
                    <div class="col-md-4 text-end">
                        <button class="btn btn-primary" id="completeBtn" onclick="completeConsultation()">
                            <i class="fas fa-check me-1"></i>完成咨询
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 聊天消息区域 -->
        <div class="chat-messages" id="chatMessages">
            <div class="empty-messages">
                <i class="fas fa-comments"></i>
                <p>加载消息中...</p>
            </div>
        </div>

        <!-- 输入区域 -->
        <div class="chat-input">
            <div class="row align-items-center">
                <div class="col-10">
                    <div class="input-group">
                        <input type="text" class="form-control" id="messageInput" placeholder="输入消息..." 
                               onkeypress="handleKeyPress(event)">
                        <button class="btn btn-outline-secondary" type="button" onclick="sendMessage()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
                <div class="col-2 text-end">
                    <button class="btn btn-outline-primary" onclick="loadMessages()">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const consultationId = '{{ consultation_id }}';
        let messages = [];
        let isLoading = false;

        // 加载咨询信息
        async function loadConsultationInfo() {
            try {
                const response = await fetch(`/api/consultation/${consultationId}`);
                if (response.ok) {
                    const consultation = await response.json();
                    document.getElementById('diseaseDescription').textContent = consultation.disease_description;
                    document.getElementById('consultationStatus').textContent = getStatusText(consultation.status);
                    document.getElementById('consultationStatus').className = `status-badge status-${consultation.status}`;
                    document.getElementById('consultationTime').textContent = new Date(consultation.created_at).toLocaleString();
                    
                    // 根据状态显示/隐藏完成按钮
                    const completeBtn = document.getElementById('completeBtn');
                    if (consultation.status === 'completed') {
                        completeBtn.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('加载咨询信息失败:', error);
            }
        }

        // 加载消息
        async function loadMessages() {
            if (isLoading) return;
            isLoading = true;
            
            try {
                const response = await fetch(`/api/consultation/${consultationId}/messages`);
                if (response.ok) {
                    messages = await response.json();
                    displayMessages();
                } else {
                    throw new Error('加载消息失败');
                }
            } catch (error) {
                console.error('加载消息失败:', error);
                showAlert('加载消息失败，请重试', 'danger');
            } finally {
                isLoading = false;
            }
        }

        // 显示消息
        function displayMessages() {
            const container = document.getElementById('chatMessages');
            
            if (messages.length === 0) {
                container.innerHTML = `
                    <div class="empty-messages">
                        <i class="fas fa-comments"></i>
                        <p>暂无消息</p>
                        <small class="text-muted">开始与患者对话吧</small>
                    </div>
                `;
                return;
            }

            const html = messages.map(message => `
                <div class="message ${message.sender_type}">
                    <img src="/static/default-avatar.png" alt="头像" class="avatar">
                    <div>
                        <div class="message-bubble">
                            ${message.message}
                        </div>
                        <div class="message-time">
                            ${new Date(message.created_at).toLocaleString()}
                        </div>
                    </div>
                </div>
            `).join('');

            container.innerHTML = html;
            
            // 滚动到底部
            container.scrollTop = container.scrollHeight;
        }

        // 发送消息
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // 清空输入框
            input.value = '';
            
            try {
                const response = await fetch(`/api/doctor/consultation/${consultationId}/send-message`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        message_type: 'text'
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    // 重新加载消息
                    loadMessages();
                } else {
                    showAlert('发送消息失败: ' + data.error, 'danger');
                }
            } catch (error) {
                console.error('发送消息失败:', error);
                showAlert('发送消息失败，请重试', 'danger');
            }
        }

        // 完成咨询
        async function completeConsultation() {
            if (!confirm('确定要完成这个咨询吗？')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/doctor/consultation/${consultationId}/complete`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                if (data.success) {
                    showAlert('咨询已完成', 'success');
                    // 隐藏完成按钮
                    document.getElementById('completeBtn').style.display = 'none';
                    // 更新状态显示
                    document.getElementById('consultationStatus').textContent = '已完成';
                    document.getElementById('consultationStatus').className = 'status-badge status-completed';
                } else {
                    showAlert('完成咨询失败: ' + data.error, 'danger');
                }
            } catch (error) {
                console.error('完成咨询失败:', error);
                showAlert('完成咨询失败，请重试', 'danger');
            }
        }

        // 处理回车键发送
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // 获取状态文本
        function getStatusText(status) {
            const texts = {
                'pending': '待支付',
                'paid': '已支付',
                'in_progress': '进行中',
                'completed': '已完成',
                'cancelled': '已取消'
            };
            return texts[status] || status;
        }

        // 显示提示信息
        function showAlert(message, type) {
            const alertContainer = document.createElement('div');
            alertContainer.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertContainer.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertContainer.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertContainer);
            
            // 3秒后自动消失
            setTimeout(() => {
                if (alertContainer.parentNode) {
                    alertContainer.remove();
                }
            }, 3000);
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadConsultationInfo();
            loadMessages();
            
            // 每30秒自动刷新消息
            setInterval(loadMessages, 30000);
        });
    </script>
</body>
</html>
